# üõ°Ô∏è NOTE: Enable branch protection for 'main' in GitHub repository settings to require this workflow's success before merging
# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Build app
        run: npm run build || echo "No build script defined, skipping"

      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_CHATTERFIX_UI }}
          channelId: live
          projectId: chatterfix-ui

      - name: Log AI usage placeholder
        run: |
          echo "Logging AI command usage (mock)..."
          echo '{"user": "${{ github.actor }}", "event": "AI_COMMAND_EXECUTED"}' > usage_log.json
          # Replace with actual logic to push to Firestore or BigQuery

      - name: Notify on Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ‚ùå Firebase Deploy Failed
          to: your@email.com
          from: ChatterFix Deploy Bot <your@email.com>
          body: |
            Deployment to Firebase failed. Check the GitHub Actions logs for details.

  manual_rollback:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Rollback to previous successful commit
        run: |
          PREV_SHA=$(git rev-list --parents -n 1 HEAD | cut -d' ' -f2)
          git reset --hard $PREV_SHA
          git push --force

  log_to_firestore:
    needs: build_and_deploy
    runs-on: ubuntu-latest
    steps:
      - name: Log deploy metadata to Firestore
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_KEY_JSON }}
        run: |
          echo "Logging deploy info to Firestore..."
          echo '{
            "timestamp": "'$(date --utc +%Y-%m-%dT%H:%M:%SZ')'",
            "status": "success",
            "commit": "'${{ github.sha }}'",
            "actor": "'${{ github.actor }}'"
          }' > deploy_log.json
          curl -X POST \
            -H "Authorization: Bearer $(gcloud auth application-default print-access-token)" \
            -H "Content-Type: application/json" \
            -d @deploy_log.json \
            "https://firestore.googleapis.com/v1/projects/chatterfix-ui/databases/(default)/documents/deployHistory"
